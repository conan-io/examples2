name: CI Examples

permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-examples:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        conan-version: [release, develop]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: "3.23"
      
      - name: Install autotools (macOS)
        if: runner.os == 'macOS'
        run: brew install automake autoconf
      
      - name: Install Conan
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [[ "${{ matrix.conan-version }}" == "develop" ]]; then
            pip install -e git+https://github.com/conan-io/conan.git@develop2#egg=conan --upgrade
          else
            pip install conan --upgrade
          fi
          pip install meson
          conan --version
          conan profile detect --force
      
      - name: Find and run examples
        shell: bash
        run: |
          export PYTHONPATH="${{ github.workspace }}${PYTHONPATH:+:$PYTHONPATH}"
          
          # Find all ci_test_example files
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXAMPLES=$(find . -name "ci_test_example.*" -type f \( -name "*.py" -o -name "*.bat" \) | sort)
          else
            EXAMPLES=$(find . -name "ci_test_example.*" -type f \( -name "*.py" -o -name "*.sh" \) | sort)
          fi
          
          # Filter out examples that require specific versions or tools not available in CI
          # FIXME: Bazel examples require specific Bazel versions (6.3.2, 7.1.2) that are not installed in GitHub Actions runners
          EXAMPLES=$(echo "$EXAMPLES" | grep -v "bazeltoolchain" || true)
          # FIXME: Cross-building examples require cross-compilation toolchains (e.g., arm-linux-gnueabihf-gcc-9) that are not installed in GitHub Actions runners
          EXAMPLES=$(echo "$EXAMPLES" | grep -v "cross_building" || true)
          
          # FIXME: Filter out tensorflow examples in PRs
          IS_PR="${{ github.event_name == 'pull_request' }}"
          if [[ "$IS_PR" == "true" ]]; then
            EXAMPLES=$(echo "$EXAMPLES" | grep -v tensorflow || true)
          fi
          
          if [[ -z "$EXAMPLES" ]]; then
            echo "No examples found to run"
            exit 0
          fi
          
          echo "Examples to run:"
          echo "$EXAMPLES"
          
          # Run each example
          set -e
          while IFS= read -r example; do
            if [[ -z "$example" ]]; then
              continue
            fi
            
            example_normalized=$(echo "$example" | sed 's|\\|/|g')
            example_dir=$(dirname "$example_normalized")
            example_file=$(basename "$example_normalized")
            
            # Start group for this example
            echo "::group::Running example: $example_dir"
            
            cd "${{ github.workspace }}/$example_dir" || exit 1
            
            if [[ "$example_file" == *.py ]]; then
              python "$example_file"
            elif [[ "$example_file" == *.sh ]]; then
              bash "$example_file"
            elif [[ "$example_file" == *.bat ]]; then
              if [[ "${{ runner.os }}" == "Windows" ]]; then
                cmd //c "$example_file"
              else
                echo "Skipping .bat file on non-Windows platform"
              fi
            fi
            
            cd "${{ github.workspace }}" || exit 1
            
            # End group for this example
            echo "::endgroup::"
          done <<< "$EXAMPLES"
