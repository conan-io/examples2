name: CI Examples

permissions:
  contents: read

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}
  pull_request:
    branches: [ main ]

jobs:
  run-examples:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        conan-version: [release, develop]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: "3.23"

      - name: Install Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelisk-version: "1.27.0"

      - name: Install autotools (macOS)
        if: runner.os == 'macOS'
        run: brew install automake autoconf

      - name: Install Conan
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [[ "${{ matrix.conan-version }}" == "develop" ]]; then
            pip install -e git+https://github.com/conan-io/conan.git@develop2#egg=conan --upgrade
          else
            pip install conan --upgrade
          fi
          pip install meson
          conan --version
          conan profile detect --force

      - name: Find and run examples
        shell: bash
        run: |
          export PYTHONPATH="${{ github.workspace }}${PYTHONPATH:+:$PYTHONPATH}"

          IS_PR="${{ github.event_name == 'pull_request' }}"
          if [[ "$IS_PR" == "true" ]]; then
            echo "Pull request detected - finding affected directories"

            # Get changed files between base and HEAD (exclude deletions)
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.base_ref }}...HEAD)
            echo "Changed files:"
            printf '%s\n' "$CHANGED_FILES"

            # Compute candidate directories from changed files and keep only those
            # that actually contain at least one ci_test_example.* file under them.
            AFFECTED_DIRS=""
            while IFS= read -r f; do
              [[ -z "$f" ]] && continue
              # Build full directory chain for the file
              dir=$(dirname "$f")
              # Normalize to ./ prefix
              dir="./$dir"
              # Walk down from deepest to root and pick the first that contains a matching example
              selected=""
              while [[ "$dir" != "." && -z "$selected" ]]; do
                if find "$dir" -type f -name "ci_test_example.*" \( -name "*.py" -o -name "*.sh" -o -name "*.bat" \) -print -quit | grep -q .; then
                  selected="$dir"
                  break
                fi
                # Move one level up
                dir="${dir%/*}"
                [[ -z "$dir" ]] && dir="."
              done
              # If none found in ancestors, skip
              if [[ -n "$selected" ]]; then
                AFFECTED_DIRS="${AFFECTED_DIRS}${selected}"$'\n'
              fi
            done <<< "$CHANGED_FILES"

            # Deduplicate and show
            AFFECTED_DIRS=$(printf '%s' "$AFFECTED_DIRS" | sed '/^$/d' | sort -u)
            echo "Affected directories (deepest with examples):"
            printf '%s\n' "$AFFECTED_DIRS"
          fi

          # Find all ci_test_example files
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXAMPLES=$(find . -name "ci_test_example.*" -type f \( -name "*.py" -o -name "*.bat" \) | sort)
          else
            EXAMPLES=$(find . -name "ci_test_example.*" -type f \( -name "*.py" -o -name "*.sh" \) | sort)
          fi

          if [[ "$IS_PR" == "true" && -n "$AFFECTED_DIRS" ]]; then
            FILTERED_EXAMPLES=""
            while IFS= read -r dir; do
              [[ -z "$dir" ]] && continue
              # Escape for grep
              dir_escaped=$(printf '%s\n' "$dir/" | sed 's/[.[\*^$(){}+?|/]/\\&/g')
              MATCHES=$(printf '%s\n' "$EXAMPLES" | grep "^${dir_escaped}" || true)
              if [[ -n "$MATCHES" ]]; then
                FILTERED_EXAMPLES="${FILTERED_EXAMPLES}${MATCHES}"$'\n'
              fi
            done <<< "$AFFECTED_DIRS"
            EXAMPLES=$(printf '%s\n' "$FILTERED_EXAMPLES" | sed '/^$/d' | sort -u)
            echo "Filtered to affected directories only:"
            printf '%s\n' "$EXAMPLES"
          fi

          # Filter out examples that require specific versions or tools not available in CI
          # FIXME: Cross-building examples require cross-compilation toolchains (e.g., arm-linux-gnueabihf-gcc-9) that are not installed in GitHub Actions runners
          EXAMPLES=$(echo "$EXAMPLES" | grep -v "cross_building" || true)

          # FIXME: Filter out tensorflow examples in PRs
          IS_PR="${{ github.event_name == 'pull_request' }}"
          if [[ "$IS_PR" == "true" ]]; then
            EXAMPLES=$(echo "$EXAMPLES" | grep -v tensorflow || true)
          fi

          if [[ -z "$EXAMPLES" ]]; then
            echo "No examples found to run"
            exit 0
          fi

          echo "Examples to run:"
          echo "$EXAMPLES"

          # Run each example
          set -e
          while IFS= read -r example; do
            if [[ -z "$example" ]]; then
              continue
            fi

            example_normalized=$(echo "$example" | sed 's|\\|/|g')
            example_dir=$(dirname "$example_normalized")
            example_file=$(basename "$example_normalized")

            # Start group for this example
            echo "::group::Running example: $example_dir"

            cd "${{ github.workspace }}/$example_dir" || exit 1

            if [[ "$example_file" == *.py ]]; then
              python "$example_file"
            elif [[ "$example_file" == *.sh ]]; then
              bash "$example_file"
            elif [[ "$example_file" == *.bat ]]; then
              if [[ "${{ runner.os }}" == "Windows" ]]; then
                cmd //c "$example_file"
              else
                echo "Skipping .bat file on non-Windows platform"
              fi
            fi

            cd "${{ github.workspace }}" || exit 1

            # End group for this example
            echo "::endgroup::"
          done <<< "$EXAMPLES"
